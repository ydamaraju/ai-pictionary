<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Hybrid: DoodleNet + Fine-Tune</title>

  <script src="js/p5.min.js"></script>
  <script src="js/ml5.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; background: #f4f7f6; color: #333; padding-bottom: 50px;}
        h2 { margin-top: 20px; color: #2c3e50; }
        canvas { border: 3px solid #2c3e50; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: crosshair; }
        .controls { margin: 20px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; max-width: 500px; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #ccc; width: 180px; font-size: 1rem; }
        button { padding: 10px 20px; border-radius: 5px; border: none; background: #007bff; color: white; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        #status { font-weight: bold; margin: 10px; color: #e67e22; min-height: 1.2em; text-align: center; max-width: 400px; }
        .prediction-box { font-size: 1.5rem; margin-bottom: 15px; background: #fff; padding: 15px 30px; border-radius: 50px; border: 2px solid #007bff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #result { color: #007bff; font-weight: bold; }
    </style>
</head>
<body>

    <h2>AI Pictionary</h2>
    
    <div class="prediction-box">
        It is a <span id="result">...</span>
    </div>

    <p id="status">Initializing AI...</p>

    <div id="canvas-container"></div>

    <div class="controls">
        <input id="labelInput" placeholder="Label (e.g. 'Star')">
        <button onclick="addExample()">Add Example</button>
        <button onclick="train()">Train Custom AI</button>
        <button class="secondary" onclick="clearCanvas()">Clear Canvas</button>
    </div>

<script>
let doodleClassifier;      
let featureExtractor;       
let customClassifier;       
let canvas;
let statusText;
let isCustomTrained = false;
let exampleCounts = {};

function setup() {
    // Safety check for ml5 loading
    if (typeof ml5 === 'undefined') {
        setTimeout(setup, 500);
        return;
    }

    canvas = createCanvas(280, 280);
    canvas.parent('canvas-container');
    background(255);
    statusText = document.getElementById('status');

    // 1. Load Pretrained DoodleNet (Standard Sketch Recognition)
    doodleClassifier = ml5.imageClassifier('DoodleNet', () => {
        statusText.innerText = "DoodleNet loaded! Draw to test.";
    });

    // 2. Load Feature Extractor (MobileNet)
    featureExtractor = ml5.featureExtractor('MobileNet', () => {
        // Link extractor to our canvas element
        customClassifier = featureExtractor.classification(canvas.elt, () => {
            console.log("Custom Classifier Ready");
        });
    });
}

function draw() {
    if (mouseIsPressed) {
        stroke(0);
        strokeWeight(14); 
        line(mouseX, mouseY, pmouseX, pmouseY);
    }
}

// Classify once the user lifts the mouse to maintain performance
function mouseReleased() {
    classify();
}

function addExample() {
    let label = document.getElementById('labelInput').value.trim();
    if (!label) { alert("Please type a label first!"); return; }

    // Use canvas.elt to ensure pixel data isn't null
    customClassifier.addImage(canvas.elt, label, () => {
        exampleCounts[label] = (exampleCounts[label] || 0) + 1;
        statusText.innerText = `Added "${label}" (${exampleCounts[label]} total)`;
        background(255); // Reset for the next sketch
    });
}

function train() {
    // FIX: Verify at least 2 different classes exist
    const labels = Object.keys(exampleCounts);
    
    if (labels.length < 2) { 
        alert("Training Error: You must add at least 2 different types of items (e.g., 'Star' and 'Moon') so the AI can learn to tell them apart."); 
        return; 
    }

    // Optional: Encourage more data for better accuracy
    for (let label of labels) {
        if (exampleCounts[label] < 2) {
            alert(`The label "${label}" needs at least 2 examples to train properly.`);
            return;
        }
    }

    statusText.innerText = "Training... please wait.";
    
    customClassifier.train((lossValue) => {
        if (lossValue == null) {
            // Training finished
            isCustomTrained = true;
            statusText.innerText = "Custom training complete! Using fine-tuned model.";
            classify();
        } else {
            // FIX: Handle both number and object types for lossValue
            let displayLoss = (typeof lossValue === 'number') ? lossValue : lossValue.loss;
            if (displayLoss !== undefined) {
                statusText.innerText = `Training... Loss: ${displayLoss.toFixed(4)}`;
            }
        }
    });
}

function classify() {
    if (isCustomTrained) {
        // Use your fine-tuned model
        customClassifier.classify(canvas.elt, (err, results) => {
            if (!err) updateUI(results);
        });
    } else if (doodleClassifier) {
        // Fallback to DoodleNet
        doodleClassifier.classify(canvas, (err, results) => {
            if (!err) updateUI(results);
        });
    }
}

function updateUI(results) {
    if (results && results[0]) {
        let label = results[0].label;
        let confidence = (results[0].confidence * 100).toFixed(1);
        document.getElementById('result').innerText = `${label} (${confidence}%)`;
    }
}

function clearCanvas() {
    background(255);
    document.getElementById('result').innerText = "...";
    if(!isCustomTrained) statusText.innerText = "DoodleNet ready.";
}
</script>

</body>
</html>